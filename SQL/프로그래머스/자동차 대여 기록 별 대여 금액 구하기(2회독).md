```SQL
WITH T AS (
    SELECT HISTORY_ID, CAR_ID, START_DATE, END_DATE, (
        CASE WHEN DATEDIFF(END_DATE, START_DATE) >= 90 THEN (100 - (SELECT DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN WHERE CAR_TYPE = '트럭' AND DURATION_TYPE = '90일 이상'))
        WHEN DATEDIFF(END_DATE, START_DATE) >= 30 THEN (100 - (SELECT DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN WHERE CAR_TYPE = '트럭' AND DURATION_TYPE = '30일 이상'))
        WHEN DATEDIFF(END_DATE, START_DATE) >= 7 THEN (100 - (SELECT DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN WHERE CAR_TYPE = '트럭' AND DURATION_TYPE = '7일 이상'))
        ELSE 100 END
    ) AS RATE
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
)


SELECT HISTORY_ID, ROUND(SUM(DAILY_FEE * (RATE / 100) * (DATEDIFF(END_DATE, START_DATE) + 1))) AS FEE
FROM T CH JOIN CAR_RENTAL_COMPANY_CAR CC ON CH.CAR_ID = CC.CAR_ID
WHERE CC.CAR_TYPE = '트럭'
GROUP BY HISTORY_ID
ORDER BY FEE DESC, HISTORY_ID DESC
```
